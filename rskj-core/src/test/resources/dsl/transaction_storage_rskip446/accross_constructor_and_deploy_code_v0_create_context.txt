comment

// CONTRACT CODE
pragma solidity ^0.8.24;
contract AcrossConstructorAndCodeV0 {
    constructor() {
        assembly{
            tstore(1, 0x0000000000000000000000000000000000000000000000000000000000000111)
        }
    }

    event OK();
    event ERROR(string, bytes32);

    function deployedCode() external {
        bytes32 valueLoadedInitially;
        bytes32 valueLoadedAfterStore;
        bytes32 valueLoadedAfterStore2;

        assembly{
            valueLoadedInitially := tload(0)
            valueLoadedAfterStore := tload(1)

            tstore(2, 0x0000000000000000000000000000000000000000000000000000000000000222)
            valueLoadedAfterStore2 := tload(2)
        }
        checkReturnValueExpected(valueLoadedInitially, 'Checking value loaded in 0 from creator is inacessible', 0x00);
        checkReturnValueExpected(valueLoadedAfterStore, 'Checking value stored in 1 from constructor is accesible', 0x0000000000000000000000000000000000000000000000000000000000000111);
        checkReturnValueExpected(valueLoadedAfterStore2, 'Checking value stored in 2 from deployed code is accesible', 0x0000000000000000000000000000000000000000000000000000000000000222);
    }

    function checkReturnValueExpected(bytes32 valueReceived, string memory message, bytes32 expectedValue) private {
        if( valueReceived == expectedValue){
            emit OK();
        } else {
            emit ERROR(message, valueReceived);
        }
    }
}

contract TestStorageCreateContexts {
    constructor(){
    }

    event OK();
    event ERROR(string, bytes32);

    function testAcrossConstructorAndCodeV0() external {
        configureTransientStorageFromCaller();
        AcrossConstructorAndCodeV0 testContract = new AcrossConstructorAndCodeV0();
        testContract.deployedCode();
        checkTransientStorageFromCaller();
    }

    function configureTransientStorageFromCaller() private {
        assembly{
            tstore(0, 0x0000000000000000000000000000000000000000000000000000000000000002)
            tstore(1, 0x0000000000000000000000000000000000000000000000000000000000000003)
            tstore(2, 0x0000000000000000000000000000000000000000000000000000000000000004)
            calldatacopy(0, 0, calldatasize())
        }
    }

    function checkTransientStorageFromCaller() private {
        bytes32 valueIn0Received;
        bytes32 valueIn1Received;
        bytes32 valueIn2Received;

        assembly{
            valueIn0Received := tload(0)
            valueIn1Received := tload(1)
            valueIn2Received := tload(2)
        }
        checkReturnValueExpected(valueIn0Received, 'Checking value in 0', 0x0000000000000000000000000000000000000000000000000000000000000002);
        checkReturnValueExpected(valueIn1Received, 'Checking value in 1', 0x0000000000000000000000000000000000000000000000000000000000000003);
        checkReturnValueExpected(valueIn2Received, 'Checking value in 2', 0x0000000000000000000000000000000000000000000000000000000000000004);
    }

    function checkReturnValueExpected(bytes32 valueReceived, string memory message, bytes32 expectedValue) private {
        if( valueReceived == expectedValue){
            emit OK();
        } else {
            emit ERROR(message, valueReceived);
        }
    }
}

// CONTRACT BYTECODE

TestStorageCreateContexts: 6080604052348015600e575f80fd5b506106248061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063573d900a1461002d575b5f80fd5b610035610037565b005b61003f6100ce565b5f60405161004c90610238565b604051809103905ff080158015610065573d5f803e3d5ffd5b5090508073ffffffffffffffffffffffffffffffffffffffff1663a45449eb6040518163ffffffff1660e01b81526004015f604051808303815f87803b1580156100ad575f80fd5b505af11580156100bf573d5f803e3d5ffd5b505050506100cb6100e2565b50565b60025f5d600360015d600460025d365f8037565b5f805f805c925060015c915060025c9050610136836040518060400160405280601381526020017f436865636b696e672076616c756520696e20300000000000000000000000000081525060025f1b6101c1565b610179826040518060400160405280601381526020017f436865636b696e672076616c756520696e20310000000000000000000000000081525060035f1b6101c1565b6101bc816040518060400160405280601381526020017f436865636b696e672076616c756520696e20320000000000000000000000000081525060045f1b6101c1565b505050565b8083036101f9577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610233565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161022a9291906102cd565b60405180910390a15b505050565b6102f3806102fc83390190565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61028782610245565b610291818561024f565b93506102a181856020860161025f565b6102aa8161026d565b840191505092915050565b5f819050919050565b6102c7816102b5565b82525050565b5f6040820190508181035f8301526102e5818561027d565b90506102f460208301846102be565b939250505056fe6080604052348015600e575f80fd5b5061011160015d6102d1806100225f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063a45449eb1461002d575b5f80fd5b610035610037565b005b5f805f805c925060015c915061022260025d60025c90506100738360405180606001604052806036815260200161022e603691395f801b6100c6565b61009a82604051806060016040528060388152602001610264603891396101115f1b6100c6565b6100c1816040518060600160405280603a81526020016101f4603a91396102225f1b6100c6565b505050565b8083036100fe577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610138565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161012f9291906101c5565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61017f8261013d565b6101898185610147565b9350610199818560208601610157565b6101a281610165565b840191505092915050565b5f819050919050565b6101bf816101ad565b82525050565b5f6040820190508181035f8301526101dd8185610175565b90506101ec60208301846101b6565b939250505056fe436865636b696e672076616c75652073746f72656420696e20322066726f6d206465706c6f79656420636f646520697320616363657369626c65436865636b696e672076616c7565206c6f6164656420696e20302066726f6d2063726561746f7220697320696e616365737369626c65436865636b696e672076616c75652073746f72656420696e20312066726f6d20636f6e7374727563746f7220697320616363657369626c65a26469706673582212209ee2571c29b98956bca0378cdf0ab06bb7e365dd067acd313c71a9295485b99c64736f6c634300081a0033a26469706673582212204abfd877c203d9e5adee353b20835eede1e284ac7e4b6640e27f13a7e025750d64736f6c634300081a0033

573d900a: testAcrossConstructorAndCodeV0()

end

# Create and fund new account
account_new acc1 10000000

# Create transaction to deploy TestTransientStorageCreateContextsContract contract
transaction_build txTestTransientStorageCreateContextsContract
    sender acc1
    receiverAddress 00
    value 0
    data 6080604052348015600e575f80fd5b506106248061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063573d900a1461002d575b5f80fd5b610035610037565b005b61003f6100ce565b5f60405161004c90610238565b604051809103905ff080158015610065573d5f803e3d5ffd5b5090508073ffffffffffffffffffffffffffffffffffffffff1663a45449eb6040518163ffffffff1660e01b81526004015f604051808303815f87803b1580156100ad575f80fd5b505af11580156100bf573d5f803e3d5ffd5b505050506100cb6100e2565b50565b60025f5d600360015d600460025d365f8037565b5f805f805c925060015c915060025c9050610136836040518060400160405280601381526020017f436865636b696e672076616c756520696e20300000000000000000000000000081525060025f1b6101c1565b610179826040518060400160405280601381526020017f436865636b696e672076616c756520696e20310000000000000000000000000081525060035f1b6101c1565b6101bc816040518060400160405280601381526020017f436865636b696e672076616c756520696e20320000000000000000000000000081525060045f1b6101c1565b505050565b8083036101f9577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610233565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161022a9291906102cd565b60405180910390a15b505050565b6102f3806102fc83390190565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61028782610245565b610291818561024f565b93506102a181856020860161025f565b6102aa8161026d565b840191505092915050565b5f819050919050565b6102c7816102b5565b82525050565b5f6040820190508181035f8301526102e5818561027d565b90506102f460208301846102be565b939250505056fe6080604052348015600e575f80fd5b5061011160015d6102d1806100225f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063a45449eb1461002d575b5f80fd5b610035610037565b005b5f805f805c925060015c915061022260025d60025c90506100738360405180606001604052806036815260200161022e603691395f801b6100c6565b61009a82604051806060016040528060388152602001610264603891396101115f1b6100c6565b6100c1816040518060600160405280603a81526020016101f4603a91396102225f1b6100c6565b505050565b8083036100fe577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610138565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161012f9291906101c5565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61017f8261013d565b6101898185610147565b9350610199818560208601610157565b6101a281610165565b840191505092915050565b5f819050919050565b6101bf816101ad565b82525050565b5f6040820190508181035f8301526101dd8185610175565b90506101ec60208301846101b6565b939250505056fe436865636b696e672076616c75652073746f72656420696e20322066726f6d206465706c6f79656420636f646520697320616363657369626c65436865636b696e672076616c7565206c6f6164656420696e20302066726f6d2063726561746f7220697320696e616365737369626c65436865636b696e672076616c75652073746f72656420696e20312066726f6d20636f6e7374727563746f7220697320616363657369626c65a26469706673582212209ee2571c29b98956bca0378cdf0ab06bb7e365dd067acd313c71a9295485b99c64736f6c634300081a0033a26469706673582212204abfd877c203d9e5adee353b20835eede1e284ac7e4b6640e27f13a7e025750d64736f6c634300081a0033
    gas 1000000
    build

# Create block to hold txTestTransientStorageCreateContextsContract transaction
block_build b01
    parent g00
    transactions txTestTransientStorageCreateContextsContract
    gasLimit 1200000
    build

# Connect block
block_connect b01

# Check b01 is best block
assert_best b01

# Create transaction to execute txInConstructorAndCode transaction
transaction_build txAcrossConstructorAndCodeV0
    sender acc1
    nonce 1
    contract txTestTransientStorageCreateContextsContract
    value 0
    data 573d900a
    gas 1000000
    build

# Create block to hold txAcrossConstructorAndCodeV0 transaction
block_build b02
    parent b01
    transactions txAcrossConstructorAndCodeV0
    gasLimit 3000000
    build

# Connect block
block_connect b02

# Check b02 is best block
assert_best b02