comment

// CONTRACT CODE
pragma solidity ^0.8.24;

contract NoConstructorCode {

    constructor() {
    }

    event OK();
    event ERROR(string, bytes32);

    function deployedCode() external {
        bytes32 valueLoadedInitially;
        bytes32 valueLoadedAfterStore;
        assembly{
            valueLoadedInitially := tload(0)
            tstore(1, 0x0000000000000000000000000000000000000000000000000000000000000555)
            valueLoadedAfterStore := tload(1)
        }
        checkReturnValueExpected(valueLoadedInitially, 'Checking value loaded in 0 from creator is inacessible in deployed code', 0x00);
        checkReturnValueExpected(valueLoadedAfterStore, 'Checking value stored in 1 from deployed is accessible', 0x0000000000000000000000000000000000000000000000000000000000000555);
    }


    function checkReturnValueExpected(bytes32 valueReceived, string memory message, bytes32 expectedValue) private {
        if( valueReceived == expectedValue){
            emit OK();
        } else {
            emit ERROR(message, valueReceived);
        }
    }
}

contract TestStorageCreateContexts {
    constructor(){
    }

    event OK();
    event ERROR(string, bytes32);

    function testNoConstructorCode() external {
        configureTransientStorageFromCaller();
        NoConstructorCode testContract = new NoConstructorCode();
        testContract.deployedCode();
        checkTransientStorageFromCaller();
    }

    function configureTransientStorageFromCaller() private {
        assembly{
            tstore(0, 0x0000000000000000000000000000000000000000000000000000000000000002)
            tstore(1, 0x0000000000000000000000000000000000000000000000000000000000000003)
            tstore(2, 0x0000000000000000000000000000000000000000000000000000000000000004)
            calldatacopy(0, 0, calldatasize())
        }
    }

    function checkTransientStorageFromCaller() private {
        bytes32 valueIn0Received;
        bytes32 valueIn1Received;
        bytes32 valueIn2Received;

        assembly{
            valueIn0Received := tload(0)
            valueIn1Received := tload(1)
            valueIn2Received := tload(2)
        }
        checkReturnValueExpected(valueIn0Received, 'Checking value in 0', 0x0000000000000000000000000000000000000000000000000000000000000002);
        checkReturnValueExpected(valueIn1Received, 'Checking value in 1', 0x0000000000000000000000000000000000000000000000000000000000000003);
        checkReturnValueExpected(valueIn2Received, 'Checking value in 2', 0x0000000000000000000000000000000000000000000000000000000000000004);
    }

    function checkReturnValueExpected(bytes32 valueReceived, string memory message, bytes32 expectedValue) private {
        if( valueReceived == expectedValue){
            emit OK();
        } else {
            emit ERROR(message, valueReceived);
        }
    }
}

// CONTRACT BYTECODE

TestStorageCreateContexts: 6080604052348015600e575f80fd5b506105c58061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063aeb8338c1461002d575b5f80fd5b610035610037565b005b61003f6100ce565b5f60405161004c90610238565b604051809103905ff080158015610065573d5f803e3d5ffd5b5090508073ffffffffffffffffffffffffffffffffffffffff1663a45449eb6040518163ffffffff1660e01b81526004015f604051808303815f87803b1580156100ad575f80fd5b505af11580156100bf573d5f803e3d5ffd5b505050506100cb6100e2565b50565b60025f5d600360015d600460025d365f8037565b5f805f805c925060015c915060025c9050610136836040518060400160405280601381526020017f436865636b696e672076616c756520696e20300000000000000000000000000081525060025f1b6101c1565b610179826040518060400160405280601381526020017f436865636b696e672076616c756520696e20310000000000000000000000000081525060035f1b6101c1565b6101bc816040518060400160405280601381526020017f436865636b696e672076616c756520696e20320000000000000000000000000081525060045f1b6101c1565b505050565b8083036101f9577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610233565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161022a9291906102cd565b60405180910390a15b505050565b610294806102fc83390190565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61028782610245565b610291818561024f565b93506102a181856020860161025f565b6102aa8161026d565b840191505092915050565b5f819050919050565b6102c7816102b5565b82525050565b5f6040820190508181035f8301526102e5818561027d565b90506102f460208301846102be565b939250505056fe6080604052348015600e575f80fd5b506102788061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063a45449eb1461002d575b5f80fd5b610035610037565b005b5f805f5c915061055560015d60015c905061006d826040518060800160405280604781526020016101c6604791395f801b610098565b6100948160405180606001604052806036815260200161020d603691396105555f1b610098565b5050565b8083036100d0577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a161010a565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd38284604051610101929190610197565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f6101518261010f565b61015b8185610119565b935061016b818560208601610129565b61017481610137565b840191505092915050565b5f819050919050565b6101918161017f565b82525050565b5f6040820190508181035f8301526101af8185610147565b90506101be6020830184610188565b939250505056fe436865636b696e672076616c7565206c6f6164656420696e20302066726f6d2063726561746f7220697320696e616365737369626c6520696e206465706c6f79656420636f6465436865636b696e672076616c75652073746f72656420696e20312066726f6d206465706c6f7965642069732061636365737369626c65a26469706673582212207a7362f3095add92a0a854cee8d39f155bec093d65abc358095a3c70c8517c3164736f6c634300081a0033a2646970667358221220f92680fe2ad24e88124b423703506fbb1ee4964eebdc02acdfe21bb7b036a13c64736f6c634300081a0033

06c31e01: testNoConstructorCode()

end

# Create and fund new account
account_new acc1 10000000

# Create transaction to deploy TestTransientStorageCreateContextsContract contract
transaction_build txTestTransientStorageCreateContextsContract
    sender acc1
    receiverAddress 00
    value 0
    data 6080604052348015600e575f80fd5b506105c58061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063aeb8338c1461002d575b5f80fd5b610035610037565b005b61003f6100ce565b5f60405161004c90610238565b604051809103905ff080158015610065573d5f803e3d5ffd5b5090508073ffffffffffffffffffffffffffffffffffffffff1663a45449eb6040518163ffffffff1660e01b81526004015f604051808303815f87803b1580156100ad575f80fd5b505af11580156100bf573d5f803e3d5ffd5b505050506100cb6100e2565b50565b60025f5d600360015d600460025d365f8037565b5f805f805c925060015c915060025c9050610136836040518060400160405280601381526020017f436865636b696e672076616c756520696e20300000000000000000000000000081525060025f1b6101c1565b610179826040518060400160405280601381526020017f436865636b696e672076616c756520696e20310000000000000000000000000081525060035f1b6101c1565b6101bc816040518060400160405280601381526020017f436865636b696e672076616c756520696e20320000000000000000000000000081525060045f1b6101c1565b505050565b8083036101f9577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a1610233565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd3828460405161022a9291906102cd565b60405180910390a15b505050565b610294806102fc83390190565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61028782610245565b610291818561024f565b93506102a181856020860161025f565b6102aa8161026d565b840191505092915050565b5f819050919050565b6102c7816102b5565b82525050565b5f6040820190508181035f8301526102e5818561027d565b90506102f460208301846102be565b939250505056fe6080604052348015600e575f80fd5b506102788061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063a45449eb1461002d575b5f80fd5b610035610037565b005b5f805f5c915061055560015d60015c905061006d826040518060800160405280604781526020016101c6604791395f801b610098565b6100948160405180606001604052806036815260200161020d603691396105555f1b610098565b5050565b8083036100d0577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a161010a565b7f76846b797b13411b14ef41db4387da9918f2f43457c5528a2423c48d45704bd38284604051610101929190610197565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f6101518261010f565b61015b8185610119565b935061016b818560208601610129565b61017481610137565b840191505092915050565b5f819050919050565b6101918161017f565b82525050565b5f6040820190508181035f8301526101af8185610147565b90506101be6020830184610188565b939250505056fe436865636b696e672076616c7565206c6f6164656420696e20302066726f6d2063726561746f7220697320696e616365737369626c6520696e206465706c6f79656420636f6465436865636b696e672076616c75652073746f72656420696e20312066726f6d206465706c6f7965642069732061636365737369626c65a26469706673582212207a7362f3095add92a0a854cee8d39f155bec093d65abc358095a3c70c8517c3164736f6c634300081a0033a2646970667358221220f92680fe2ad24e88124b423703506fbb1ee4964eebdc02acdfe21bb7b036a13c64736f6c634300081a0033
    gas 1000000
    build

# Create block to hold txTestTransientStorageCreateContextsContract transaction
block_build b01
    parent g00
    transactions txTestTransientStorageCreateContextsContract
    gasLimit 1200000
    build

# Connect block
block_connect b01

# Check b01 is best block
assert_best b01

# Create transaction to execute txNoConstructorCode transaction
transaction_build txNoConstructorCode
    sender acc1
    nonce 1
    contract txTestTransientStorageCreateContextsContract
    value 0
    data aeb8338c
    gas 1000000
    build

# Create block to hold txNoConstructorCode transaction
block_build b02
    parent b01
    transactions txNoConstructorCode
    gasLimit 2000000
    build

# Connect block
block_connect b02

# Check b02 is best block
assert_best b02