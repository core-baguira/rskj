comment

// CONTRACT CODE

pragma solidity ^0.8.24;

contract TstorageReentrancyContextTest {
    bool reentrant = false;
    uint256 success;
    uint256 valueLoadedAfterSubcall;
    uint256 valueLoadedBeforeSubcall;
    uint256 valueLoadedInSubcall;

    constructor() {
    }

    event OK();
    event ERROR(string, uint256);

    function manipulateInReentrantCall() external {
        bytes memory data = abi.encodeWithSignature("manipulateInReentrantCall()");

        assembly {
            let reentrantValue := sload(reentrant.slot)
            switch reentrantValue
            case 0 {
                sstore(reentrant.slot, true)

                tstore(0xFF, 0x100)
                sstore(valueLoadedBeforeSubcall.slot, tload(0xFF))
                mstore(0, 2)
                sstore(success.slot, call(gas(), address(), 0, add(data, 0x20), mload(data), 0, 0))
                sstore(valueLoadedAfterSubcall.slot, tload(0xFF))
            }
            default {
                tstore(0xFF, 0x101)
                sstore(valueLoadedInSubcall.slot, tload(0xFF))
            }
        }
    }

    function checkValuesStoredInTstorage() external {
        checkReturnValueExpected(valueLoadedBeforeSubcall, 'Checking value from tload before subcall', 0x100);
        checkReturnValueExpected(success, 'Checking result callee execution is with success', 1);
        checkReturnValueExpected(valueLoadedInSubcall, 'Checking value from tload inside subcall', 0x101);
        checkReturnValueExpected(valueLoadedAfterSubcall, 'Checking value from tload after subcall ', 0x101);
    }

    function checkReturnValueExpected(uint256 valueReceived, string memory message, uint256 expectedValue) private {
        if( valueReceived == expectedValue){
            emit OK();
        } else {
            emit ERROR(message, valueReceived);
        }
    }
}

// CONTRACT BYTECODE

TstorageReentrancyContextTest: 60806040525f805f6101000a81548160ff021916908315150217905550348015610027575f80fd5b506103de806100355f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80631ff644ef146100385780635f6813d114610042575b5f80fd5b61004061004c565b005b61004a61011c565b005b5f6040516024016040516020818303038152906040527f1ff644ef000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f54805f81146100ed5761010160ff5d60ff5c600455610117565b60015f5561010060ff5d60ff5c60035560025f525f808451602086015f305af160015560ff5c6002555b505050565b610143600354604051806060016040528060288152602001610301602891396101006101b9565b6101696001546040518060600160405280603081526020016103296030913960016101b9565b610190600454604051806060016040528060288152602001610381602891396101016101b9565b6101b7600254604051806060016040528060288152602001610359602891396101016101b9565b565b8083036101f1577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a161022b565b7fc9e730d5b570f89e168eb8c3d29f8c396b957e540af248c95c9519ac47c2c69f82846040516102229291906102d2565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b5f5b8381101561026757808201518184015260208101905061024c565b5f8484015250505050565b5f601f19601f8301169050919050565b5f61028c82610230565b610296818561023a565b93506102a681856020860161024a565b6102af81610272565b840191505092915050565b5f819050919050565b6102cc816102ba565b82525050565b5f6040820190508181035f8301526102ea8185610282565b90506102f960208301846102c3565b939250505056fe436865636b696e672076616c75652066726f6d20746c6f6164206265666f72652073756263616c6c436865636b696e6720726573756c742063616c6c656520657865637574696f6e20697320776974682073756363657373436865636b696e672076616c75652066726f6d20746c6f61642061667465722073756263616c6c20436865636b696e672076616c75652066726f6d20746c6f616420696e736964652073756263616c6ca26469706673582212205eaa2b45243abfc23eb1044a5fe2ff7c133a9d27dc7ee1836eed96d02a8919ea64736f6c63430008180033

5f6813d1: checkValuesStoredInTstorage()
1ff644ef: manipulateInReentrantCall()

end

# Create and fund new account
account_new acc1 10000000

# Create transaction to deploy TstorageReentrancyContextTest contract
transaction_build txTstorageReentrancyContextTestContract
    sender acc1
    receiverAddress 00
    value 0
    data 60806040525f805f6101000a81548160ff021916908315150217905550348015610027575f80fd5b506103de806100355f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c80631ff644ef146100385780635f6813d114610042575b5f80fd5b61004061004c565b005b61004a61011c565b005b5f6040516024016040516020818303038152906040527f1ff644ef000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f54805f81146100ed5761010160ff5d60ff5c600455610117565b60015f5561010060ff5d60ff5c60035560025f525f808451602086015f305af160015560ff5c6002555b505050565b610143600354604051806060016040528060288152602001610301602891396101006101b9565b6101696001546040518060600160405280603081526020016103296030913960016101b9565b610190600454604051806060016040528060288152602001610381602891396101016101b9565b6101b7600254604051806060016040528060288152602001610359602891396101016101b9565b565b8083036101f1577fd48fe2800bace8f5ca2450feacbd6efc681b1cd0115019bb49fa529b6171bf6760405160405180910390a161022b565b7fc9e730d5b570f89e168eb8c3d29f8c396b957e540af248c95c9519ac47c2c69f82846040516102229291906102d2565b60405180910390a15b505050565b5f81519050919050565b5f82825260208201905092915050565b5f5b8381101561026757808201518184015260208101905061024c565b5f8484015250505050565b5f601f19601f8301169050919050565b5f61028c82610230565b610296818561023a565b93506102a681856020860161024a565b6102af81610272565b840191505092915050565b5f819050919050565b6102cc816102ba565b82525050565b5f6040820190508181035f8301526102ea8185610282565b90506102f960208301846102c3565b939250505056fe436865636b696e672076616c75652066726f6d20746c6f6164206265666f72652073756263616c6c436865636b696e6720726573756c742063616c6c656520657865637574696f6e20697320776974682073756363657373436865636b696e672076616c75652066726f6d20746c6f61642061667465722073756263616c6c20436865636b696e672076616c75652066726f6d20746c6f616420696e736964652073756263616c6ca26469706673582212205eaa2b45243abfc23eb1044a5fe2ff7c133a9d27dc7ee1836eed96d02a8919ea64736f6c63430008180033
    gas 1000000
    build

# Create block to hold txTstorageReentrancyContextTestContract transaction
block_build b01
    parent g00
    transactions txTstorageReentrancyContextTestContract
    gasLimit 1200000
    build

# Connect block
block_connect b01

# Check b01 is best block
assert_best b01

# Create transaction to execute txManipulateInReentrantCall transaction
transaction_build txManipulateInReentrantCall
    sender acc1
    nonce 1
    contract txTstorageReentrancyContextTestContract
    value 0
    data 1ff644ef
    gas 300000
    build

# Create block to hold txManipulateInReentrantCall transaction
block_build b02
    parent b01
    transactions txManipulateInReentrantCall
    gasLimit 350000
    build

# Connect block
block_connect b02

# Check b02 is best block
assert_best b02

# Create transaction to execute txCheckValuesStoredInTstorage transaction
transaction_build txCheckValuesStoredInTstorage transaction
    sender acc1
    nonce 2
    contract txTstorageReentrancyContextTestContract
    value 0
    data 5f6813d1
    gas 300000
    build

# Create block to hold txCheckValuesStoredInTstorage transaction
block_build b03
    parent b02
    transactions txCheckValuesStoredInTstorage
    gasLimit 350000
    build

# Connect block
block_connect b03

# Check b03 is best block
assert_best b03